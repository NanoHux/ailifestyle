datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id             Int             @id @default(autoincrement())
  email          String          @unique
  passwordHash   String?         @map("password_hash")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  
  profile        UserProfile?
  chatSessions   ChatSession[]
  messages       Message[]
  dayPlans       DayPlan[]
  dayReflections DayReflection[]
  habitTemplates HabitTemplate[]

  @@map("users")
}

model UserProfile {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique @map("user_id")
  displayName     String?   @map("display_name")
  timezone        String?   @default("Asia/Shanghai")
  wakeTime        DateTime? @map("wake_time")
  sleepTime       DateTime? @map("sleep_time")
  workStartTime   DateTime? @map("work_start_time")
  workEndTime     DateTime? @map("work_end_time")
  pacePreference  String?   @map("pace_preference")
  stylePreference String?   @map("style_preference")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model ChatSession {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  title       String?
  relatedDate DateTime? @map("related_date")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@map("chat_sessions")
}

model Message {
  id            Int      @id @default(autoincrement())
  sessionId     Int      @map("session_id")
  userId        Int      @map("user_id")
  role          String
  content       String
  aiRawPayload  String?  @map("ai_raw_payload")
  hasPlanUpdate Boolean  @default(false) @map("has_plan_update")
  createdAt     DateTime @default(now()) @map("created_at")

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model DayPlan {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  planDate      DateTime @map("plan_date")
  dayGoal       String?  @map("day_goal")
  overallAdvice String?  @map("overall_advice")
  status        String   @default("active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  blocks PlanBlock[]

  @@unique([userId, planDate])
  @@map("day_plans")
}

model PlanBlock {
  id                  Int      @id @default(autoincrement())
  dayPlanId           Int      @map("day_plan_id")
  startTime           DateTime @map("start_time")
  endTime             DateTime @map("end_time")
  title               String
  description         String?
  notes               String?
  category            String?
  priority            String?
  status              String   @default("pending")
  fromPreviousBlockId Int?     @map("from_previous_block_id")
  aiBlockId           String?  @map("ai_block_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  dayPlan       DayPlan     @relation(fields: [dayPlanId], references: [id], onDelete: Cascade)
  previousBlock PlanBlock?  @relation("BlockHistory", fields: [fromPreviousBlockId], references: [id])
  nextBlocks    PlanBlock[] @relation("BlockHistory")

  @@map("plan_blocks")
}

model DayReflection {
  id             Int      @id @default(autoincrement())
  userId         Int      @map("user_id")
  planDate       DateTime @map("plan_date")
  selfRating     Int?     @map("self_rating")
  userNotes      String?  @map("user_notes")
  aiSummary      String?  @map("ai_summary")
  completionRate Float?   @map("completion_rate")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, planDate])
  @@map("day_reflections")
}

model HabitTemplate {
  id                     Int      @id @default(autoincrement())
  userId                 Int      @map("user_id")
  name                   String
  defaultDurationMinutes Int?     @map("default_duration_minutes")
  recommendedTimeOfDay   String?  @map("recommended_time_of_day")
  category               String?
  isActive               Boolean  @default(true) @map("is_active")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("habit_templates")
}
